# AWSTemplateFormatVersion: '2010-09-09'
# Description: 'Production Infrastructure for Scheme App - India Region (ap-south-1) with Auto-Scaling'

# Parameters:
#   EnvironmentName:
#     Type: String
#     Default: production
#     Description: Environment name
  
#   AppName:
#     Type: String
#     Default: scheme-app
#     Description: Application name
  
#   DockerImageUri:
#     Type: String
#     Description: Docker image URI from ECR (e.g., 123456789.dkr.ecr.ap-south-1.amazonaws.com/scheme-app:latest)
  
#   DesiredTaskCount:
#     Type: Number
#     Default: 2
#     MinValue: 1
#     MaxValue: 4
#     Description: Initial number of ECS tasks
  
#   DatabasePassword:
#     Type: String
#     NoEcho: true
#     MinLength: 8
#     Description: PostgreSQL master password (minimum 8 characters)

# Resources:
#   # ==================== VPC & NETWORKING ====================
#   VPC:
#     Type: AWS::EC2::VPC
#     Properties:
#       CidrBlock: 10.0.0.0/16
#       EnableDnsHostnames: true
#       EnableDnsSupport: true
#       Tags:
#         - Key: Name
#           Value: !Sub '${AppName}-vpc'

#   InternetGateway:
#     Type: AWS::EC2::InternetGateway

#   AttachGateway:
#     Type: AWS::EC2::VPCGatewayAttachment
#     Properties:
#       VpcId: !Ref VPC
#       InternetGatewayId: !Ref InternetGateway

#   # Public Subnets (for ALB)
#   PublicSubnet1:
#     Type: AWS::EC2::Subnet
#     Properties:
#       VpcId: !Ref VPC
#       CidrBlock: 10.0.1.0/24
#       AvailabilityZone: ap-south-1a
#       MapPublicIpOnLaunch: true

#   PublicSubnet2:
#     Type: AWS::EC2::Subnet
#     Properties:
#       VpcId: !Ref VPC
#       CidrBlock: 10.0.2.0/24
#       AvailabilityZone: ap-south-1b
#       MapPublicIpOnLaunch: true

#   # Private Subnets (for RDS)
#   PrivateSubnet1:
#     Type: AWS::EC2::Subnet
#     Properties:
#       VpcId: !Ref VPC
#       CidrBlock: 10.0.10.0/24
#       AvailabilityZone: ap-south-1a

#   PrivateSubnet2:
#     Type: AWS::EC2::Subnet
#     Properties:
#       VpcId: !Ref VPC
#       CidrBlock: 10.0.11.0/24
#       AvailabilityZone: ap-south-1b

#   # Route Tables
#   PublicRouteTable:
#     Type: AWS::EC2::RouteTable
#     Properties:
#       VpcId: !Ref VPC

#   PublicRoute:
#     Type: AWS::EC2::Route
#     Properties:
#       RouteTableId: !Ref PublicRouteTable
#       DestinationCidrBlock: 0.0.0.0/0
#       GatewayId: !Ref InternetGateway

#   PublicSubnet1RouteAssociation:
#     Type: AWS::EC2::SubnetRouteTableAssociation
#     Properties:
#       SubnetId: !Ref PublicSubnet1
#       RouteTableId: !Ref PublicRouteTable

#   PublicSubnet2RouteAssociation:
#     Type: AWS::EC2::SubnetRouteTableAssociation
#     Properties:
#       SubnetId: !Ref PublicSubnet2
#       RouteTableId: !Ref PublicRouteTable

#   PrivateRouteTable:
#     Type: AWS::EC2::RouteTable
#     Properties:
#       VpcId: !Ref VPC

#   PrivateSubnet1RouteAssociation:
#     Type: AWS::EC2::SubnetRouteTableAssociation
#     Properties:
#       SubnetId: !Ref PrivateSubnet1
#       RouteTableId: !Ref PrivateRouteTable

#   PrivateSubnet2RouteAssociation:
#     Type: AWS::EC2::SubnetRouteTableAssociation
#     Properties:
#       SubnetId: !Ref PrivateSubnet2
#       RouteTableId: !Ref PrivateRouteTable

#   # ==================== SECURITY GROUPS ====================
#   ALBSecurityGroup:
#     Type: AWS::EC2::SecurityGroup
#     Properties:
#       GroupDescription: ALB Security Group
#       VpcId: !Ref VPC
#       SecurityGroupIngress:
#         - IpProtocol: tcp
#           FromPort: 80
#           ToPort: 80
#           CidrIp: 0.0.0.0/0
#         - IpProtocol: tcp
#           FromPort: 443
#           ToPort: 443
#           CidrIp: 0.0.0.0/0
#       SecurityGroupEgress:
#         - IpProtocol: -1
#           CidrIp: 0.0.0.0/0

#   ECSSecurityGroup:
#     Type: AWS::EC2::SecurityGroup
#     Properties:
#       GroupDescription: ECS Tasks Security Group
#       VpcId: !Ref VPC
#       SecurityGroupIngress:
#         - IpProtocol: tcp
#           FromPort: 3000
#           ToPort: 3000
#           SourceSecurityGroupId: !Ref ALBSecurityGroup
#       SecurityGroupEgress:
#         - IpProtocol: -1
#           CidrIp: 0.0.0.0/0

#   RDSSecurityGroup:
#     Type: AWS::EC2::SecurityGroup
#     Properties:
#       GroupDescription: RDS Security Group
#       VpcId: !Ref VPC
#       SecurityGroupIngress:
#         - IpProtocol: tcp
#           FromPort: 5432
#           ToPort: 5432
#           SourceSecurityGroupId: !Ref ECSSecurityGroup
#       SecurityGroupEgress:
#         - IpProtocol: -1
#           CidrIp: 0.0.0.0/0

#   # ==================== APPLICATION LOAD BALANCER ====================
#   LoadBalancer:
#     Type: AWS::ElasticLoadBalancingV2::LoadBalancer
#     Properties:
#       Name: !Sub '${AppName}-alb'
#       Type: application
#       Scheme: internet-facing
#       IpAddressType: ipv4
#       Subnets:
#         - !Ref PublicSubnet1
#         - !Ref PublicSubnet2
#       SecurityGroups:
#         - !Ref ALBSecurityGroup

#   TargetGroup:
#     Type: AWS::ElasticLoadBalancingV2::TargetGroup
#     Properties:
#       Name: !Sub '${AppName}-tg'
#       Port: 3000
#       Protocol: HTTP
#       VpcId: !Ref VPC
#       TargetType: ip
#       HealthCheckEnabled: true
#       HealthCheckIntervalSeconds: 30
#       HealthCheckPath: /api/health
#       HealthCheckProtocol: HTTP
#       HealthCheckTimeoutSeconds: 5
#       HealthyThresholdCount: 2
#       UnhealthyThresholdCount: 3
#       Matcher:
#         HttpCode: 200-299

#   ALBListener:
#     Type: AWS::ElasticLoadBalancingV2::Listener
#     Properties:
#       LoadBalancerArn: !Ref LoadBalancer
#       Port: 80
#       Protocol: HTTP
#       DefaultActions:
#         - Type: forward
#           TargetGroupArn: !Ref TargetGroup

#   # ==================== ECS CLUSTER ====================
#   ECSCluster:
#     Type: AWS::ECS::Cluster
#     Properties:
#       ClusterName: !Sub '${AppName}-cluster'

#   ECSTaskExecutionRole:
#     Type: AWS::IAM::Role
#     Properties:
#       AssumeRolePolicyDocument:
#         Version: '2012-10-17'
#         Statement:
#           - Effect: Allow
#             Principal:
#               Service: ecs-tasks.amazonaws.com
#             Action: sts:AssumeRole
#       ManagedPolicyArns:
#         - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy

#   ECSTaskRole:
#     Type: AWS::IAM::Role
#     Properties:
#       AssumeRolePolicyDocument:
#         Version: '2012-10-17'
#         Statement:
#           - Effect: Allow
#             Principal:
#               Service: ecs-tasks.amazonaws.com
#             Action: sts:AssumeRole

#   CloudWatchLogsGroup:
#     Type: AWS::Logs::LogGroup
#     Properties:
#       LogGroupName: !Sub '/ecs/${AppName}'
#       RetentionInDays: 7

#   TaskDefinition:
#     Type: AWS::ECS::TaskDefinition
#     Properties:
#       Family: !Sub '${AppName}-task'
#       NetworkMode: awsvpc
#       RequiresCompatibilities:
#         - FARGATE
#       Cpu: '256'
#       Memory: '512'
#       ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
#       TaskRoleArn: !GetAtt ECSTaskRole.Arn
#       ContainerDefinitions:
#         - Name: !Ref AppName
#           Image: !Ref DockerImageUri
#           PortMappings:
#             - ContainerPort: 3000
#               HostPort: 3000
#               Protocol: tcp
#           Environment:
#             - Name: NODE_ENV
#               Value: production
#             - Name: DATABASE_URL
#               Value: !Sub 'postgresql://admin:${DatabasePassword}@${DBInstance.Endpoint.Address}:5432/schemedb'
#           LogConfiguration:
#             LogDriver: awslogs
#             Options:
#               awslogs-group: !Ref CloudWatchLogsGroup
#               awslogs-region: ap-south-1
#               awslogs-stream-prefix: ecs
#           HealthCheck:
#             Command:
#               - CMD-SHELL
#               - curl -f http://localhost:3000/api/health || exit 1
#             Interval: 30
#             Timeout: 5
#             Retries: 3
#             StartPeriod: 60

#   ECSService:
#     Type: AWS::ECS::Service
#     DependsOn: ALBListener
#     Properties:
#       ServiceName: !Sub '${AppName}-service'
#       Cluster: !Ref ECSCluster
#       TaskDefinition: !Ref TaskDefinition
#       DesiredCount: !Ref DesiredTaskCount
#       LaunchType: FARGATE
#       NetworkConfiguration:
#         AwsvpcConfiguration:
#           AssignPublicIp: ENABLED
#           Subnets:
#             - !Ref PublicSubnet1
#             - !Ref PublicSubnet2
#           SecurityGroups:
#             - !Ref ECSSecurityGroup
#       LoadBalancers:
#         - ContainerName: !Ref AppName
#           ContainerPort: 3000
#           TargetGroupArn: !Ref TargetGroup
#       DeploymentConfiguration:
#         MaximumPercent: 200
#         MinimumHealthyPercent: 100
#       HealthCheckGracePeriodSeconds: 60

#   # ==================== AUTO-SCALING ====================
#   ServiceScalingTarget:
#     Type: AWS::ApplicationAutoScaling::ScalableTarget
#     Properties:
#       MaxCapacity: 4
#       MinCapacity: 1
#       ResourceId: !Sub 'service/${ECSCluster}/${ECSService.Name}'
#       RoleARN: !Sub 'arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService'
#       ScalableDimension: ecs:service:DesiredCount
#       ServiceNamespace: ecs

#   ScalingPolicy:
#     Type: AWS::ApplicationAutoScaling::ScalingPolicy
#     Properties:
#       PolicyName: !Sub '${AppName}-scaling-policy'
#       PolicyType: TargetTrackingScaling
#       ScalingTargetId: !Ref ServiceScalingTarget
#       TargetTrackingScalingPolicyConfiguration:
#         TargetValue: 70.0
#         PredefinedMetricSpecification:
#           PredefinedMetricType: ECSServiceAverageCPUUtilization
#         ScaleOutCooldown: 60
#         ScaleInCooldown: 300

#   # ==================== RDS DATABASE ====================
#   DBSubnetGroup:
#     Type: AWS::RDS::DBSubnetGroup
#     Properties:
#       DBSubnetGroupDescription: Subnet group for RDS
#       SubnetIds:
#         - !Ref PrivateSubnet1
#         - !Ref PrivateSubnet2

#   DBInstance:
#     Type: AWS::RDS::DBInstance
#     DeletionPolicy: Snapshot
#     Properties:
#       DBInstanceIdentifier: scheme-db
#       DBInstanceClass: db.t3.small
#       Engine: postgres
#       EngineVersion: '15'
#       MasterUsername: admin
#       MasterUserPassword: !Ref DatabasePassword
#       AllocatedStorage: '20'
#       StorageType: gp3
#       DBName: schemedb
#       DBSubnetGroupName: !Ref DBSubnetGroup
#       VPCSecurityGroups:
#         - !Ref RDSSecurityGroup
#       MultiAZ: true
#       BackupRetentionPeriod: 7
#       PreferredBackupWindow: '03:00-04:00'
#       PreferredMaintenanceWindow: 'sun:04:00-sun:05:00'
#       StorageEncrypted: true
#       EnableCloudwatchLogsExports:
#         - postgresql

# Outputs:
#   LoadBalancerDNS:
#     Description: Load Balancer DNS Name
#     Value: !GetAtt LoadBalancer.DNSName
#     Export:
#       Name: !Sub '${AppName}-alb-dns'

#   ECSClusterName:
#     Description: ECS Cluster Name
#     Value: !Ref ECSCluster
#     Export:
#       Name: !Sub '${AppName}-cluster-name'

#   ECSServiceName:
#     Description: ECS Service Name
#     Value: !GetAtt ECSService.Name
#     Export:
#       Name: !Sub '${AppName}-service-name'

#   DatabaseEndpoint:
#     Description: RDS Database Endpoint
#     Value: !GetAtt DBInstance.Endpoint.Address
#     Export:
#       Name: !Sub '${AppName}-db-endpoint'

#   LogGroupName:
#     Description: CloudWatch Log Group
#     Value: !Ref CloudWatchLogsGroup
#     Export:
#       Name: !Sub '${AppName}-log-group'
